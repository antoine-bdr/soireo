<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/events"></ion-back-button>
    </ion-buttons>
    <ion-title>D√©tail</ion-title>
    <ion-buttons slot="end" *ngIf="permissions?.canEditEvent">
      <ion-button (click)="editEvent()">
        <ion-icon slot="icon-only" name="create-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="deleteEvent()" color="danger">
        <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="refreshEvent($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
  
  <!-- ========================================
       LOADING STATE
       ======================================== -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Chargement de l'√©v√©nement...</p>
  </div>

  <!-- ========================================
       EVENT DETAIL CONTENT
       ======================================== -->
  <div *ngIf="!isLoading && event && permissions" class="event-detail-container">
    
    <!-- ========================================
         HERO SECTION (Image + Badges + Titre)
         ======================================== -->
    <div class="event-hero">
      <div class="event-image-container">
        <!-- Image principale -->
        <img 
          [src]="event.imageUrl || 'assets/default-event.jpg'" 
          [class.loaded]="imageLoaded"
          class="event-image"
          (load)="onImageLoad()"
          (error)="onImageError($event)" 
          alt="{{ event.title }}" />
        
        <!-- Skeleton loading -->
        <div class="image-skeleton" *ngIf="!imageLoaded && !imageError">
          <ion-spinner></ion-spinner>
        </div>

        <!-- Error overlay -->
        <div class="image-error-overlay" *ngIf="imageError">
          <ion-icon name="image-outline"></ion-icon>
          <p>Image non disponible</p>
        </div>

        <!-- Gradient overlay -->
        <div class="image-overlay"></div>
        
        <!-- Badge Organisateur (top-right) -->
        <ion-chip *ngIf="isOrganizer" class="organizer-badge">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <ion-label>Organisateur</ion-label>
        </ion-chip>

        <!-- Badge Complet (bottom-left) -->
        <ion-chip *ngIf="isEventFull()" class="full-badge" color="danger">
          <ion-icon name="close-circle-outline"></ion-icon>
          <ion-label>Complet</ion-label>
        </ion-chip>

        <!-- Badge Participant (bottom-right) -->
        <ion-chip *ngIf="isParticipating && !isOrganizer" class="participating-badge" color="success">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <ion-label>Participant</ion-label>
        </ion-chip>

        <!-- Badge Annul√© (center) -->
        <ion-chip *ngIf="event.status === 'cancelled'" class="cancelled-badge" color="danger">
          <ion-icon name="ban-outline"></ion-icon>
          <ion-label>ANNUL√â</ion-label>
        </ion-chip>
      </div>

      <!-- Informations principales (Titre + Compteur) -->
      <div class="event-header-info">
        <h1 class="event-title">{{ event.title }}</h1>
        <div class="event-meta">
          <ion-chip class="participants-chip" [color]="isEventFull() ? 'danger' : 'primary'">
            <ion-icon name="people-outline"></ion-icon>
            <ion-label>{{ participantCount }}/{{ event.maxParticipants }}</ion-label>
          </ion-chip>
        </div>
      </div>
    </div>

    <!-- ========================================
         BANNI√àRE √âV√âNEMENT ANNUL√â
         ======================================== -->
    <div *ngIf="event.status === 'cancelled'" class="cancelled-banner">
      <ion-icon name="warning-outline" color="danger"></ion-icon>
      <div class="banner-content">
        <h3>√âv√©nement annul√©</h3>
        <p>Cet √©v√©nement a √©t√© annul√© par l'organisateur.</p>
        <p class="cancelled-date" *ngIf="event.cancelledAt">
          Annul√© le {{ formatDate(event.cancelledAt) }}
        </p>
      </div>
    </div>

    <!-- ========================================
         üì® SECTION INVITATION (INVITE_ONLY)
         ======================================== -->
    <div *ngIf="isInviteOnly() && !isOrganizer && event.status !== 'cancelled'" class="participation-section">
      
      <!-- Cas 1: Utilisateur NON invit√© et NON participant -->
      <div *ngIf="!hasInvitation && !isParticipating" class="invite-only-notice">
        <ion-icon name="lock-closed-outline" color="primary"></ion-icon>
        <div class="notice-content">
          <h3>√âv√©nement sur invitation uniquement</h3>
          <p>Cet √©v√©nement est priv√© et accessible uniquement sur invitation de l'organisateur.</p>
        </div>
      </div>

      <!-- Cas 2: Utilisateur INVIT√â (avec invitation PENDING) -->
      <div *ngIf="hasInvitation && !isParticipating">
        <ion-card class="invitation-received-card">
          <ion-card-content>
            <div class="invitation-received-message">
              <ion-icon name="mail-outline" color="primary" class="large-icon"></ion-icon>
              <h2>Vous √™tes invit√© !</h2>
              <p>{{ event.organizerName }} vous a invit√© √† participer √† cet √©v√©nement.</p>
            </div>

            <div class="invitation-buttons">
              <ion-button 
                expand="block" 
                color="success"
                [disabled]="isAcceptingInvitation"
                (click)="acceptInvitation()">
                <ion-spinner *ngIf="isAcceptingInvitation" slot="start"></ion-spinner>
                <ion-icon *ngIf="!isAcceptingInvitation" slot="start" name="checkmark-circle-outline"></ion-icon>
                <span *ngIf="!isAcceptingInvitation">Accepter l'invitation</span>
              </ion-button>

              <ion-button 
                expand="block" 
                fill="outline"
                color="danger"
                [disabled]="isDecliningInvitation"
                (click)="declineInvitation()">
                <ion-spinner *ngIf="isDecliningInvitation" slot="start"></ion-spinner>
                <ion-icon *ngIf="!isDecliningInvitation" slot="start" name="close-circle-outline"></ion-icon>
                <span *ngIf="!isDecliningInvitation">Refuser</span>
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Cas 3: D√©j√† participant -->
      <ion-button 
        *ngIf="isParticipating"
        expand="block" 
        color="medium"
        [disabled]="isLeaving"
        (click)="leaveEvent()">
        <ion-spinner *ngIf="isLeaving" slot="start"></ion-spinner>
        <ion-icon *ngIf="!isLeaving" slot="start" name="exit-outline"></ion-icon>
        <span *ngIf="!isLeaving">Annuler ma participation</span>
      </ion-button>
    </div>

    <!-- ========================================
         üîÑ SECTION PARTICIPATION (PUBLIC/PRIVATE)
         ======================================== -->
    <div *ngIf="!isInviteOnly() && !isOrganizer && event.status !== 'cancelled'" class="participation-section">
      
      <!-- Bouton Participer -->
      <ion-button 
        *ngIf="!isParticipating && canJoin"
        expand="block" 
        color="primary"
        [disabled]="isJoining"
        (click)="joinEvent()">
        <ion-spinner *ngIf="isJoining" slot="start"></ion-spinner>
        <ion-icon *ngIf="!isJoining" slot="start" name="person-add-outline"></ion-icon>
        <span *ngIf="!isJoining">Participer √† cet √©v√©nement</span>
      </ion-button>
      
      <!-- Bouton Annuler participation -->
      <ion-button 
        *ngIf="isParticipating"
        expand="block" 
        color="medium"
        [disabled]="isLeaving"
        (click)="leaveEvent()">
        <ion-spinner *ngIf="isLeaving" slot="start"></ion-spinner>
        <ion-icon *ngIf="!isLeaving" slot="start" name="exit-outline"></ion-icon>
        <span *ngIf="!isLeaving">Annuler ma participation</span>
      </ion-button>
      
      <!-- Message si ne peut pas rejoindre -->
      <div *ngIf="!canJoin && !isParticipating && canJoinReason" class="cannot-join-message">
        <ion-chip color="warning">
          <ion-icon name="warning-outline"></ion-icon>
          <ion-label>{{ canJoinReason }}</ion-label>
        </ion-chip>
      </div>
    </div>

    <!-- ========================================
         üìë SEGMENTS DE NAVIGATION
         ======================================== -->
    <ion-segment 
      [(ngModel)]="selectedSegment" 
      (ionChange)="onSegmentChange($event)"
      class="event-segments">
      
      <ion-segment-button value="info">
        <ion-label>Infos</ion-label>
      </ion-segment-button>
      
      <ion-segment-button value="announcements" *ngIf="permissions.canViewAnnouncements">
        <ion-label>Annonces</ion-label>
        <ion-badge *ngIf="announcementCount">{{ announcementCount }}</ion-badge>
      </ion-segment-button>
      
      <ion-segment-button value="photos" *ngIf="permissions.canViewPhotos">
        <ion-label>Photos</ion-label>
        <ion-badge *ngIf="photoCount">{{ photoCount }}</ion-badge>
      </ion-segment-button>
      
      <ion-segment-button value="participants" *ngIf="permissions.canViewParticipants">
        <ion-label>Participants</ion-label>
      </ion-segment-button>
    </ion-segment>

    <!-- ========================================
         CONTENU DES SEGMENTS
         ======================================== -->
    <div [ngSwitch]="selectedSegment" class="segment-content">
      <app-info-segment 
        *ngSwitchCase="'info'"
        [event]="event"
        [permissions]="permissions"
        [addressDisplay]="addressDisplay">
      </app-info-segment>
      
      <app-announcements-segment 
        *ngSwitchCase="'announcements'"
        [eventId]="eventId"
        [permissions]="permissions"
        (announcementCountChanged)="onAnnouncementCountChanged($event)">
      </app-announcements-segment>
      
      <app-photos-segment 
        *ngSwitchCase="'photos'"
        [eventId]="eventId"
        [event]="event"
        [permissions]="permissions"
        (photoCountChanged)="onPhotoCountChanged($event)"
        (eventUpdated)="refreshEvent()">
      </app-photos-segment>
      
      <app-participants-segment 
        *ngSwitchCase="'participants'"
        [eventId]="eventId"
        [event]="event"
        [permissions]="permissions"
        (participantCountChanged)="onParticipantCountChanged($event)">
      </app-participants-segment>
    </div>
  </div>
</ion-content>