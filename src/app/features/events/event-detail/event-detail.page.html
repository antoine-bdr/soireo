<!-- event-detail.page.html -->
<!-- ‚úÖ VERSION avec menu organisateur en haut √† droite -->

<!-- LOADING -->
<div class="loading-container" *ngIf="isLoading">
  <ion-spinner name="crescent" color="primary"></ion-spinner>
  <p>Chargement de l'√©v√©nement...</p>
</div>

<!-- CONTENT -->
<ion-content [fullscreen]="true" *ngIf="!isLoading && event">

  <!-- ‚úÖ PULL-TO-REFRESH -->
  <ion-refresher slot="fixed" (ionRefresh)="refreshEvent($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Tirer pour actualiser"
      refreshingSpinner="circles"
      refreshingText="Actualisation...">
    </ion-refresher-content>
  </ion-refresher>

  <!-- IMAGE HEADER -->
  <div class="event-image-header">
    <img 
      [src]="event.imageUrl || 'assets/placeholder-event.jpg'" 
      [alt]="event.title" 
      class="header-image" />
    <div class="image-overlay"></div>
    
    <!-- Bouton retour avec ARIA -->
    <ion-button 
      class="back-button" 
      fill="clear" 
      (click)="goBack()"
      aria-label="Retour √† la liste des √©v√©nements"
      title="Retour">
      <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
    </ion-button>

    <!-- ‚úÖ NOUVEAU : Bouton Options Organisateur -->
    <ion-button 
      *ngIf="isOrganizer"
      class="options-button" 
      fill="clear" 
      (click)="showOrganizerOptions()"
      aria-label="Options de l'√©v√©nement"
      title="Options">
      <ion-icon name="ellipsis-vertical" slot="icon-only"></ion-icon>
    </ion-button>

    <!-- Badges flottants -->
    <div class="floating-badges">
      <ion-badge class="floating-badge organizer-badge" *ngIf="isOrganizer" color="warning">
        ‚≠ê Organisateur
      </ion-badge>
      <ion-badge class="floating-badge full-badge" *ngIf="isEventFull()" color="danger">
        üîí COMPLET
      </ion-badge>
      <ion-badge class="floating-badge participating-badge" *ngIf="isParticipating && !isOrganizer" color="success">
        ‚úì Inscrit
      </ion-badge>
      <ion-badge class="floating-badge private-badge" *ngIf="event.isPrivate" color="dark">
        üîí Priv√©
      </ion-badge>
      <ion-badge class="floating-badge masked-badge" *ngIf="isAddressMasked()" color="medium">
        üìç Adresse masqu√©e
      </ion-badge>
    </div>
  </div>

  <!-- CONTENU PRINCIPAL -->
  <div class="detail-content">

    <!-- TITRE + BADGES -->
    <div class="header-section">
      <h1 class="event-title">{{ event.title }}</h1>

      <div class="inline-badges">
        <ion-chip class="category-chip">
          <ion-label>{{ getCategoryLabel(event.category) }}</ion-label>
        </ion-chip>

        <ion-chip class="access-type-chip" [attr.data-access-type]="getEventAccessType()">
          <ion-icon [name]="getAccessTypeIcon()"></ion-icon>
          <ion-label>{{ getAccessTypeLabel() }}</ion-label>
        </ion-chip>

        <ion-chip [attr.data-status]="getParticipantBadgeStatus()" class="participants-chip">
          <ion-icon name="people-outline"></ion-icon>
          <ion-label>{{ participantCount }}/{{ event.maxParticipants }}</ion-label>
        </ion-chip>
      </div>
    </div>

    <!-- BOUTONS PARTICIPATION -->
    <div class="action-section" *ngIf="!isOrganizer">
      
      <!-- Non inscrit -->
      <ion-button 
        *ngIf="!isParticipating && !isPending() && !isEventFull()"
        expand="block"
        class="participate-button"
        (click)="joinEvent()"
        aria-label="Participer √† cet √©v√©nement">
        <ion-icon name="person-add-outline" slot="start"></ion-icon>
        Participer √† cet √©v√©nement
      </ion-button>

      <!-- En attente -->
      <div *ngIf="isPending()" class="pending-status-container">
        <div class="pending-badge-box">
          <ion-icon name="time-outline" color="warning"></ion-icon>
          <div class="pending-text">
            <h4>Demande envoy√©e</h4>
            <p>L'organisateur doit approuver votre participation</p>
          </div>
        </div>
        <ion-button 
          expand="block" 
          class="cancel-request-button" 
          fill="outline" 
          color="warning" 
          (click)="cancelRequest()"
          aria-label="Annuler ma demande de participation">
          <ion-icon name="close-circle-outline" slot="start"></ion-icon>
          Annuler la demande
        </ion-button>
      </div>

      <!-- Approuv√© -->
      <div *ngIf="isParticipating && !isPending()" class="approved-status-container">
        <div class="approved-badge-box">
          <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
          <span>Vous participez √† cet √©v√©nement</span>
        </div>
        <ion-button 
          expand="block" 
          class="leave-button" 
          fill="outline" 
          color="danger" 
          (click)="leaveEvent()"
          aria-label="Me d√©sinscrire de l'√©v√©nement">
          <ion-icon name="exit-outline" slot="start"></ion-icon>
          Se d√©sinscrire
        </ion-button>
      </div>

      <!-- Complet -->
      <div class="full-message" *ngIf="isEventFull() && !isParticipating && !isPending()">
        <ion-icon name="warning-outline"></ion-icon>
        <p>Cet √©v√©nement est complet</p>
      </div>
    </div>

    <!-- ‚úÖ NAVIGATION SEGMENTS avec ngSwitch pour performance -->
    <ion-segment 
      [(ngModel)]="selectedSegment" 
      class="segment-navigation"
      aria-label="Navigation entre les sections">
      <ion-segment-button 
        value="info"
        aria-label="Section informations">
        <ion-icon name="information-circle-outline"></ion-icon>
        <ion-label>Infos</ion-label>
      </ion-segment-button>
      
      <ion-segment-button 
        value="announcements"
        aria-label="Section annonces">
        <ion-icon name="megaphone-outline"></ion-icon>
        <ion-label>Annonces</ion-label>
        <ion-badge *ngIf="announcementCount > 0" color="danger">{{ announcementCount }}</ion-badge>
      </ion-segment-button>
      
      <ion-segment-button 
        value="photos"
        aria-label="Section photos">
        <ion-icon name="camera-outline"></ion-icon>
        <ion-label>Photos</ion-label>
        <ion-badge *ngIf="photoCount > 0" color="primary">{{ photoCount }}</ion-badge>
      </ion-segment-button>
      
      <ion-segment-button 
        value="participants"
        aria-label="Section participants">
        <ion-icon name="people-outline"></ion-icon>
        <ion-label>Participants</ion-label>
        <ion-badge color="success">{{ participantCount }}</ion-badge>
      </ion-segment-button>
    </ion-segment>

    <!-- ‚úÖ CONTENU SEGMENTS avec ngSwitch (meilleure performance) -->
    <div class="segment-content">
      <ng-container [ngSwitch]="selectedSegment">
        
        <app-info-segment 
          *ngSwitchCase="'info'"
          [event]="event"
          [isOrganizer]="isOrganizer"
          [participantStatus]="participantStatus">
        </app-info-segment>
        
        <app-announcements-segment 
          *ngSwitchCase="'announcements'"
          [eventId]="eventId"
          [isOrganizer]="isOrganizer"
          (announcementCountChanged)="onAnnouncementCountChanged($event)">
        </app-announcements-segment>
        
        <app-photos-segment 
          *ngSwitchCase="'photos'"
          [eventId]="eventId"
          [event]="event"
          (photoCountChanged)="onPhotoCountChanged($event)"
          (eventUpdated)="onEventUpdated()">
        </app-photos-segment>
        
        <app-participants-segment 
          *ngSwitchCase="'participants'"
          [eventId]="eventId"
          [event]="event"
          [isOrganizer]="isOrganizer"
          (participantCountChanged)="onParticipantCountChanged($event)">
        </app-participants-segment>
        
      </ng-container>
    </div>

    <!-- ‚ùå SUPPRIM√â : Section organizer-actions -->

    <div class="bottom-spacing"></div>

  </div>

</ion-content>