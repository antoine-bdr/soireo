<!-- ========================================
     üé® EVENT DETAIL - DARK PREMIUM GLASSMORPHISM
     ‚úÖ VERSION AVEC GESTION CONDITIONNELLE PAR STATUT
     ======================================== -->

<!-- ========================================
     LOADING STATE
     ======================================== -->
     <div class="loading-container" *ngIf="isLoading">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p>Chargement de l'√©v√©nement...</p>
    </div>
    
    <!-- ========================================
         CONTENT PRINCIPAL
         ======================================== -->
    <ion-content [fullscreen]="true" *ngIf="!isLoading && event">
    
      <!-- ========================================
           IMAGE HEADER FULL-WIDTH
           ======================================== -->
      <div class="event-image-header">
        <img 
          [src]="event.imageUrl || 'assets/placeholder-event.jpg'" 
          [alt]="event.title"
          class="header-image" />
        
        <!-- Gradient overlay -->
        <div class="image-overlay"></div>
        
        <!-- Bouton retour flottant -->
        <ion-button 
          class="back-button"
          fill="clear"
          (click)="goBack()">
          <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
        </ion-button>
    
        <!-- Badges flottants -->
        <div class="floating-badges">
          <!-- Badge principal (toujours visible) -->
          <ion-badge 
            class="floating-badge primary-badge"
            [color]="getPrimaryBadge().color">
            {{ getPrimaryBadge().text }}
          </ion-badge>
        
          <!-- Badge secondaire (optionnel) -->
          <ion-badge 
            *ngIf="getSecondaryBadge()"
            class="floating-badge secondary-badge"
            [color]="getSecondaryBadge()!.color">
            {{ getSecondaryBadge()!.text }}
          </ion-badge>

          <ion-badge 
            class="floating-badge invited-badge" 
            *ngIf="isInvited && !isParticipating"
            color="primary">
            ‚úâÔ∏è Invit√©
          </ion-badge>
        </div>
      </div>
    
      <!-- ========================================
           CONTENU PRINCIPAL
           ======================================== -->
      <div class="detail-content">
            
        <!-- ========================================
             ‚úÖ BOUTON PARTICIPATION (selon statut)
             ======================================== -->
             <div class="action-section" *ngIf="!isOrganizer && canRequestParticipation()">

              <!-- ========================================
     ‚úâÔ∏è INVITATION (pour l'invit√©)
     ======================================== -->
              <ion-card 
              class="invitation-card glassmorphism" 
              *ngIf="isInvited && userInvitation && !isParticipating">
              <ion-card-content>
                <div class="invitation-header">
                  <ion-icon name="mail-outline" color="primary"></ion-icon>
                  <h3>Vous √™tes invit√© !</h3>
                </div>
                
                <p class="invitation-message">
                  <strong>{{ userInvitation.inviterName }}</strong> vous invite √† participer √† cet √©v√©nement.
                </p>

                <div class="invitation-actions">
                  <ion-button 
                    expand="block" 
                    color="success"
                    (click)="acceptInvitation()">
                    <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                    Accepter l'invitation
                  </ion-button>

                  <ion-button 
                    expand="block" 
                    fill="outline" 
                    color="medium"
                    (click)="declineInvitation()">
                    <ion-icon name="close-circle-outline" slot="start"></ion-icon>
                    Refuser
                  </ion-button>
                </div>
              </ion-card-content>
              </ion-card>
  
              <!-- √âTAT 1 : NON INSCRIT - Bouton Participer -->
              <ion-button 
                *ngIf="!isParticipating && !isPending() && canJoinEvent()"
                expand="block"
                class="participate-button"
                (click)="joinEvent()"
                [disabled]="isJoining">
                <ion-icon name="person-add-outline" slot="start"></ion-icon>
                {{ isJoining ? 'Inscription en cours...' : 'Participer √† cet √©v√©nement' }}
              </ion-button>
            
              <!-- √âTAT 2 : DEMANDE EN ATTENTE (PENDING) -->
              <div *ngIf="isPending()" class="pending-status-container">
                <!-- Badge statut -->
                <div class="pending-badge-box">
                  <ion-icon name="time-outline" color="warning"></ion-icon>
                  <div class="pending-text">
                    <h4>Demande envoy√©e</h4>
                    <p>L'organisateur doit approuver votre participation</p>
                  </div>
                </div>
            
                <!-- Bouton Annuler la demande -->
                <ion-button 
                  expand="block"
                  class="cancel-request-button"
                  fill="outline"
                  color="warning"
                  (click)="cancelRequest()"
                  [disabled]="isLeaving">
                  <ion-icon name="close-circle-outline" slot="start"></ion-icon>
                  {{ isLeaving ? 'Annulation...' : 'Annuler la demande' }}
                </ion-button>
              </div>
            
              <!-- √âTAT 3 : APPROUV√â - Bouton Se d√©sinscrire -->
              <div *ngIf="isParticipating && !isPending()" class="approved-status-container">
                <!-- Badge confirmation -->
                <div class="approved-badge-box">
                  <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
                  <span>Vous participez √† cet √©v√©nement</span>
                </div>
            
                <!-- Bouton Se d√©sinscrire -->
                <ion-button 
                  expand="block"
                  class="leave-button"
                  fill="outline"
                  color="danger"
                  (click)="leaveEvent()"
                  [disabled]="isLeaving">
                  <ion-icon name="exit-outline" slot="start"></ion-icon>
                  {{ isLeaving ? 'D√©sinscription...' : 'Se d√©sinscrire' }}
                </ion-button>
              </div>
            
              <!-- MESSAGE : √âV√âNEMENT COMPLET -->
              <div class="full-message" *ngIf="isEventFull() && !isParticipating && !isPending()">
                <ion-icon name="warning-outline" color="warning"></ion-icon>
                <p>Cet √©v√©nement est complet</p>
              </div>
            
              <!-- MESSAGE : NE PEUT PAS REJOINDRE (autre raison) -->
              <div class="cannot-join-message" 
                   *ngIf="!isParticipating && !isPending() && !canJoinEvent() && !isEventFull() && canJoinReason">
                <ion-icon name="information-circle-outline" color="medium"></ion-icon>
                <p>{{ canJoinReason }}</p>
              </div>
            </div>

            <!-- ‚úÖ MESSAGE : √âV√âNEMENT TERMIN√â OU ANNUL√â -->
            <div class="event-status-message" *ngIf="eventStatus === EventStatus.COMPLETED">
              <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
              <p>Cet √©v√©nement est termin√©</p>
            </div>

            <div class="event-status-message" *ngIf="eventStatus === EventStatus.CANCELLED">
              <ion-icon name="close-circle-outline" color="danger"></ion-icon>
              <p>Cet √©v√©nement a √©t√© annul√©</p>
            </div>
    
        <!-- ========================================
             CARD INFO PRINCIPALE
             ======================================== -->
        <ion-card class="info-card glassmorphism">
          <ion-card-content>
            
            <!-- Titre -->
            <h1 class="event-title">{{ event.title }}</h1>
    
            <!-- Badges cat√©gorie, type d'acc√®s et participants -->
            <div class="inline-badges">
              <ion-chip class="category-chip">
                <ion-label>{{ getCategoryLabel(event.category) }}</ion-label>
              </ion-chip>
    
              <!-- Badge type d'√©v√©nement -->
              <ion-chip 
                class="access-type-chip"
                [attr.data-access-type]="getEventAccessType()">
                <ion-icon [name]="getAccessTypeIcon()"></ion-icon>
                <ion-label>{{ getAccessTypeLabel() }}</ion-label>
              </ion-chip>
    
              <ion-chip 
                [attr.data-status]="getParticipantBadgeStatus()"
                class="participants-chip">
                <ion-icon name="people-outline"></ion-icon>
                <ion-label>{{ participantCount }} / {{ event.maxParticipants }}</ion-label>
              </ion-chip>
            </div>
    
            <!-- Informations principales -->
            <div class="event-meta">
              <!-- Date -->
              <div class="meta-row">
                <ion-icon name="calendar-outline" class="meta-icon"></ion-icon>
                <div class="meta-content">
                  <span class="meta-label">Date</span>
                  <span class="meta-value">
                    {{ event.startTime && event.endTime ? formatDateOnly(event.date) : formatDate(event.date) }}
                  </span>
                </div>
              </div>

              <!-- Horaires et dur√©e (si disponibles) -->
              <div class="meta-row" *ngIf="event.startTime && event.endTime">
                <ion-icon name="time-outline" class="meta-icon"></ion-icon>
                <div class="meta-content">
                  <span class="meta-label">Horaires</span>
                  <span class="meta-value">
                    {{ formatTime(event.startTime) }} - {{ formatTime(event.endTime) }}
                    <span class="duration-badge" *ngIf="getEventDuration()">
                      ({{ getEventDuration() }})
                    </span>
                  </span>
                </div>
              </div>
    
              <!-- Localisation -->
              <div class="meta-row">
                <ion-icon 
                  [name]="isAddressMasked() ? 'eye-off-outline' : 'location-outline'" 
                  class="meta-icon"
                  [class.masked-icon]="isAddressMasked()">
                </ion-icon>
                <div class="meta-content">
                  <span class="meta-label">Localisation</span>
                  
                  <!-- Adresse visible -->
                  <span 
                    class="meta-value" 
                    *ngIf="!isAddressMasked()">
                    üìç {{ getAddressDisplay() }}
                  </span>
                  
                  <!-- Adresse masqu√©e -->
                  <span 
                    class="meta-value address-masked" 
                    *ngIf="isAddressMasked()">
                    üìç {{ getAddressDisplay() }}
                  </span>
                </div>
              </div>
            </div>
    
            <!-- Message explicatif si adresse masqu√©e -->
            <div class="location-message-box" *ngIf="isAddressMasked()">
              <ion-icon name="information-circle-outline" color="primary"></ion-icon>
              <p>{{ getLocationMessage() }}</p>
            </div>
    
          </ion-card-content>
        </ion-card>

        <!-- ========================================
             ‚úÖ SECTION CHECK-IN (uniquement ONGOING)
             ======================================== -->
        <ion-card 
        class="checkin-card glassmorphism" 
        *ngIf="eventStatus === EventStatus.ONGOING && isParticipating">
        <ion-card-content>
          <h3 class="section-title">
            <ion-icon name="checkmark-done-outline"></ion-icon>
            Check-in
          </h3>

          <div class="checkin-stats">
            <ion-chip color="primary">
              <ion-label>{{ checkInCount }} pr√©sent(s)</ion-label>
            </ion-chip>
          </div>

          <!-- ‚úÖ Bouton check-in avec v√©rification g√©olocalisation -->
          <div class="checkin-actions" *ngIf="canDoCheckIn()">
            <p class="checkin-info">
              <ion-icon name="information-circle-outline"></ion-icon>
              Vous devez √™tre √† l'adresse de l'√©v√©nement (moins de 100m)
            </p>
            <ion-button expand="block" (click)="doCheckIn()">
              <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
              Je suis arriv√©(e) !
            </ion-button>
          </div>

          <div class="checkin-success" *ngIf="hasCheckedIn">
            <ion-icon name="checkmark-circle" color="success"></ion-icon>
            <p>Pr√©sence confirm√©e !</p>
          </div>
        </ion-card-content>
        </ion-card>

        <!-- ========================================
             ‚úÖ SECTION ANNONCES (tous statuts sauf CANCELLED)
             ======================================== -->
        <ion-card 
        class="announcements-card glassmorphism" 
        *ngIf="(announcements.length > 0 || canPostAnnouncement()) && eventStatus !== EventStatus.CANCELLED">
        <ion-card-content>
          <div class="section-header">
            <h3 class="section-title">
              <ion-icon name="megaphone-outline"></ion-icon>
              Annonces
            </h3>
            
            <!-- ‚úÖ Bouton ajouter annonce (selon statut) -->
            <ion-button 
              *ngIf="canPostAnnouncement()" 
              fill="clear" 
              size="small"
              (click)="postAnnouncement()">
              <ion-icon name="add-circle-outline"></ion-icon>
            </ion-button>
          </div>

          <div class="announcements-list" *ngIf="announcements.length > 0">
            <div class="announcement-item" *ngFor="let announcement of announcements">
              <div class="announcement-header">
                <span class="announcement-author">{{ announcement.authorName }}</span>
                <span class="announcement-time">{{ formatDate(announcement.timestamp) }}</span>
              </div>
              <p class="announcement-message">{{ announcement.message }}</p>
            </div>
          </div>

          <div class="empty-announcements" *ngIf="announcements.length === 0">
            <p>Aucune annonce pour le moment</p>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- ========================================
           ‚úÖ SECTION PHOTOS (ONGOING ou COMPLETED)
           ======================================== -->
      <!-- ========================================
     ‚úÖ SECTION PHOTOS (ONGOING ou COMPLETED)
     ======================================== -->
<ion-card 
class="photos-card glassmorphism" 
*ngIf="canAddPhotos()">
<ion-card-content>
  <div class="section-header">
    <h3 class="section-title">
      <ion-icon name="images-outline"></ion-icon>
      Photos de l'√©v√©nement
    </h3>
    
    <ion-button 
      fill="clear" 
      size="small"
      (click)="addEventPhotos()">
      <ion-icon name="camera-outline"></ion-icon>
    </ion-button>
  </div>

  <!-- Aper√ßu des photos -->
      <div class="photos-preview" *ngIf="photoPreview.length > 0">
        <div class="photos-grid">
          <div 
            class="photo-item" 
            *ngFor="let photo of photoPreview"
            (click)="openPhotoGallery()">
            <img [src]="photo" alt="Photo √©v√©nement" />
          </div>
        </div>

        <!-- Bouton "Voir tout" -->
        <ion-button 
          expand="block" 
          fill="outline" 
          size="small"
          class="view-all-btn"
          (click)="openPhotoGallery()">
          <ion-icon name="images-outline" slot="start"></ion-icon>
          Voir toutes les photos ({{ event?.eventPhotos?.length || 0 }})
        </ion-button>
      </div>

      <!-- Placeholder si aucune photo -->
      <p class="photos-placeholder" *ngIf="photoPreview.length === 0">
        <ion-icon name="camera-outline"></ion-icon>
        Les participants peuvent ajouter des photos pendant et apr√®s l'√©v√©nement
      </p>
    </ion-card-content>
    </ion-card>
    
        <!-- ========================================
             CARD ORGANISATEUR
             ======================================== -->
        <ion-card class="organizer-card glassmorphism">
          <ion-card-content>
            <h3 class="section-title">
              <ion-icon name="person-outline"></ion-icon>
              Organisateur
            </h3>
    
            <div class="organizer-info">
              <ion-avatar class="organizer-avatar">
                <img 
                  [src]="event.organizerPhoto || 'assets/default-avatar.png'"
                  [alt]="event.organizerName" />
              </ion-avatar>
              <div class="organizer-details">
                <p class="organizer-name">{{ event.organizerName }}</p>
                <p class="organizer-label">Cr√©ateur de l'√©v√©nement</p>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
    
        <!-- ========================================
             CARD DESCRIPTION
             ======================================== -->
        <ion-card class="description-card glassmorphism">
          <ion-card-content>
            <h3 class="section-title">
              <ion-icon name="document-text-outline"></ion-icon>
              Description
            </h3>
            <p class="description-text">{{ event.description }}</p>
          </ion-card-content>
        </ion-card>
    
        <!-- ========================================
             ‚úÖ CARD DEMANDES EN ATTENTE (Organisateur + UPCOMING/ONGOING)
             ======================================== -->
        <ion-card 
          class="pending-requests-card glassmorphism" 
          *ngIf="isOrganizer && event.requiresApproval && pendingCount > 0 && canRequestParticipation()">
          <ion-card-content>
            <div class="pending-header">
              <h3 class="section-title">
                <ion-icon name="notifications-outline"></ion-icon>
                Demandes en attente
              </h3>
              <ion-badge color="danger" class="pending-badge">
                {{ pendingCount }}
              </ion-badge>
            </div>
            
            <p class="pending-description">
              {{ pendingCount }} personne(s) souhaite(nt) rejoindre votre √©v√©nement
            </p>
    
            <ion-button
              expand="block"
              (click)="openPendingRequestsModal()"
              class="manage-requests-button">
              <ion-icon name="notifications-outline" slot="start"></ion-icon>
              G√©rer les demandes
            </ion-button>
          </ion-card-content>
        </ion-card>
    
        <!-- ========================================
     üë• LISTE DES PARTICIPANTS
     ======================================== -->
      <!-- ========================================
     üë• APER√áU DES PARTICIPANTS
     ======================================== -->
      <ion-card class="participants-card glassmorphism" *ngIf="participants.length > 0">
        <ion-card-content>
          <div class="section-header">
            <h3 class="section-title">
              <ion-icon name="people-outline"></ion-icon>
              Participants ({{ participantCount }})
            </h3>
            <ion-button 
              fill="clear" 
              size="small"
              (click)="openParticipantsModal()">
              Voir tous
              <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
            </ion-button>
          </div>

          <!-- Liste horizontale des 5 derniers -->
          <div class="participants-preview">
            <div 
              class="participant-preview-item" 
              *ngFor="let participant of getPreviewParticipants()"
              (click)="viewParticipantProfile(participant.userId)">
              <ion-avatar class="preview-avatar">
                <img 
                  [src]="participant.userPhoto || 'assets/default-avatar.png'" 
                  [alt]="participant.userName" />
                <div 
                  *ngIf="participant.userId === event?.organizerId" 
                  class="organizer-star">
                  ‚≠ê
                </div>
              </ion-avatar>
              <p class="preview-name">{{ participant.userName }}</p>
            </div>

            <!-- Indicateur "+X autres" si plus de 5 participants -->
            <div 
              class="participant-preview-item more-indicator" 
              *ngIf="participants.length > 5"
              (click)="openParticipantsModal()">
              <div class="more-avatar">
                <span>+{{ participants.length - 5 }}</span>
              </div>
              <p class="preview-name">Autres</p>
            </div>
          </div>

        </ion-card-content>
        <!-- ========================================
     üì® INVITATIONS (Organisateur uniquement)
     ======================================== -->
        <ion-card 
        class="invitations-card glassmorphism" 
        *ngIf="isOrganizer && invitations.length > 0">
        <ion-card-content>
          <div class="section-header">
            <h3 class="section-title">
              <ion-icon name="mail-outline"></ion-icon>
              Invitations envoy√©es
            </h3>
            <ion-button 
              fill="clear" 
              size="small"
              (click)="openInviteFriendsModal()">
              <ion-icon name="add-circle-outline"></ion-icon>
              Inviter
            </ion-button>
          </div>

          <!-- Stats invitations -->
          <div class="invitation-stats" *ngIf="invitationStats">
            <div class="stat-item">
              <span class="stat-value">{{ invitationStats.totalInvited }}</span>
              <span class="stat-label">Envoy√©es</span>
            </div>
            <div class="stat-item success">
              <span class="stat-value">{{ invitationStats.acceptedCount }}</span>
              <span class="stat-label">Accept√©es</span>
            </div>
            <div class="stat-item warning">
              <span class="stat-value">{{ invitationStats.pendingCount }}</span>
              <span class="stat-label">En attente</span>
            </div>
            <div class="stat-item danger">
              <span class="stat-value">{{ invitationStats.declinedCount }}</span>
              <span class="stat-label">Refus√©es</span>
            </div>
          </div>

          <!-- Liste des invitations -->
          <div class="invitations-list">
            <div 
              class="invitation-item" 
              *ngFor="let invitation of invitations.slice(0, 5)"
              [class.pending]="invitation.status === 'pending'"
              [class.accepted]="invitation.status === 'accepted'"
              [class.declined]="invitation.status === 'declined'">
              
              <ion-avatar>
                <img 
                  [src]="invitation.invitedUserPhoto || 'assets/default-avatar.png'" 
                  [alt]="invitation.invitedUserName" />
              </ion-avatar>

              <div class="invitation-info">
                <p class="name">{{ invitation.invitedUserName }}</p>
                <p class="status">
                  <ion-icon 
                    [name]="invitation.status === 'pending' ? 'time-outline' : 
                            invitation.status === 'accepted' ? 'checkmark-circle' : 
                            'close-circle'"
                    [color]="invitation.status === 'pending' ? 'warning' : 
                            invitation.status === 'accepted' ? 'success' : 
                            'danger'">
                  </ion-icon>
                  {{ invitation.status === 'pending' ? 'En attente' : 
                    invitation.status === 'accepted' ? 'Accept√©e' : 
                    'Refus√©e' }}
                </p>
              </div>
            </div>
          </div>

          <!-- Voir toutes les invitations -->
          <ion-button 
            *ngIf="invitations.length > 5"
            expand="block" 
            fill="outline" 
            size="small">
            Voir toutes les invitations ({{ invitations.length }})
          </ion-button>
        </ion-card-content>
        </ion-card>
      </ion-card>
    
        <!-- ========================================
             ‚úÖ ACTIONS ORGANISATEUR (selon statut)
             ======================================== -->
        <div class="organizer-actions" *ngIf="isOrganizer">
          <!-- ‚úÖ Modifier (UPCOMING ou ONGOING) -->

          <ion-button 
            *ngIf="canInviteFriends()"
            expand="block"
            color="primary"
            class="invite-button"
            (click)="openInviteFriendsModal()">
            <ion-icon name="mail-outline" slot="start"></ion-icon>
            Inviter des amis
          </ion-button>

          <ion-button 
            *ngIf="canEditEvent()"
            expand="block"
            class="edit-button"
            (click)="editEvent()">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            Modifier l'√©v√©nement
          </ion-button>
    
          <!-- ‚úÖ Supprimer (uniquement UPCOMING) -->
          <ion-button 
            *ngIf="canDeleteEvent()"
            expand="block"
            class="delete-button"
            fill="outline"
            color="danger"
            (click)="deleteEvent()">
            <ion-icon name="trash-outline" slot="start"></ion-icon>
            Supprimer l'√©v√©nement
          </ion-button>

          <!-- ‚úÖ Message si pas possible de modifier/supprimer -->
          <div class="action-disabled-message" *ngIf="!canEditEvent() && !canDeleteEvent()">
            <ion-icon name="information-circle-outline" color="medium"></ion-icon>
            <p *ngIf="eventStatus === EventStatus.COMPLETED">
              Les √©v√©nements termin√©s ne peuvent plus √™tre modifi√©s
            </p>
            <p *ngIf="eventStatus === EventStatus.CANCELLED">
              Les √©v√©nements annul√©s ne peuvent plus √™tre modifi√©s
            </p>
            <p *ngIf="eventStatus === EventStatus.ONGOING && !canDeleteEvent()">
              Un √©v√©nement en cours ne peut pas √™tre supprim√©
            </p>
          </div>
        </div>
    
        <!-- Spacing bottom -->
        <div class="bottom-spacing"></div>
    
      </div>
      <ion-fab *ngIf="hasFabActions()" vertical="bottom" horizontal="end" slot="fixed">
        <ion-fab-button color="primary">
          <ion-icon name="ellipsis-vertical"></ion-icon>
        </ion-fab-button>
        
        <ion-fab-list side="top">
          <!-- Actions contextuelles selon le statut et le r√¥le -->
          <ion-fab-button 
            *ngIf="canEditEvent()"
            (click)="editEvent()"
            data-desc="Modifier">
            <ion-icon name="create-outline"></ion-icon>
          </ion-fab-button>
          
          <ion-fab-button 
            *ngIf="canShare()"
            (click)="shareEvent()"
            data-desc="Partager">
            <ion-icon name="share-outline"></ion-icon>
          </ion-fab-button>
        </ion-fab-list>
      </ion-fab>
    </ion-content>