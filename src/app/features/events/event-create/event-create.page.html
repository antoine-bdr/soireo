<!-- ========================================
     üéâ EVENT CREATE PAGE - AVEC DUR√âE D'√âV√âNEMENT
     ‚úÖ Ajout : S√©lecteur de dur√©e et affichage heure de fin
     ======================================== -->

     <ion-header>
      <ion-toolbar color="primary">
        <ion-buttons slot="start">
          <ion-back-button defaultHref="/events" text="Retour"></ion-back-button>
        </ion-buttons>
        <ion-title>Cr√©er un √©v√©nement</ion-title>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="ion-padding">
      
      <form [formGroup]="eventForm" (ngSubmit)="createEvent()">
        
        <!-- ========================================
             SECTION IMAGE
             ======================================== -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="camera-outline"></ion-icon>
              Photo de l'√©v√©nement
            </ion-card-title>
          </ion-card-header>
          
          <ion-card-content>
            <!-- Pr√©visualisation de l'image -->
            <div class="image-preview-container" *ngIf="imagePreview">
              <img [src]="imagePreview" alt="Aper√ßu" class="image-preview" />
              <ion-button 
                fill="clear" 
                color="danger" 
                class="remove-image-btn"
                (click)="removeImage()">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </div>
    
            <!-- Bouton de s√©lection d'image -->
            <div class="upload-container" *ngIf="!imagePreview">
              <input 
                type="file" 
                #fileInput 
                accept="image/*" 
                (change)="onImageSelected($event)"
                style="display: none" />
              <ion-button 
                expand="block" 
                fill="outline"
                (click)="fileInput.click()">
                <ion-icon name="camera-outline" slot="start"></ion-icon>
                Choisir une image
              </ion-button>
              <p class="hint">JPG, PNG, GIF ou WebP - Max 5MB</p>
            </div>
          </ion-card-content>
        </ion-card>
    
        <!-- ========================================
             SECTION INFORMATIONS G√âN√âRALES
             ======================================== -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Informations g√©n√©rales</ion-card-title>
          </ion-card-header>
          
          <ion-card-content>
            
            <!-- Titre -->
            <ion-item lines="full">
              <ion-label position="floating">Titre de l'√©v√©nement *</ion-label>
              <ion-input 
                type="text" 
                formControlName="title"
                placeholder="Ex: Soir√©e d'anniversaire">
              </ion-input>
            </ion-item>
            <div class="error-message" *ngIf="title?.invalid && title?.touched">
              <ion-text color="danger" *ngIf="title?.errors?.['required']">
                <small>Le titre est requis</small>
              </ion-text>
              <ion-text color="danger" *ngIf="title?.errors?.['minlength']">
                <small>Minimum 3 caract√®res</small>
              </ion-text>
            </div>
    
            <!-- Description -->
            <ion-item lines="full">
              <ion-label position="floating">Description *</ion-label>
              <ion-textarea 
                formControlName="description"
                rows="4"
                placeholder="D√©cris ton √©v√©nement...">
              </ion-textarea>
            </ion-item>
            <div class="error-message" *ngIf="description?.invalid && description?.touched">
              <ion-text color="danger" *ngIf="description?.errors?.['required']">
                <small>La description est requise</small>
              </ion-text>
              <ion-text color="danger" *ngIf="description?.errors?.['minlength']">
                <small>Minimum 10 caract√®res</small>
              </ion-text>
            </div>
    
            <!-- Cat√©gorie -->
            <ion-item lines="full">
              <ion-label position="floating">Cat√©gorie *</ion-label>
              <ion-select formControlName="category" interface="action-sheet">
                <ion-select-option 
                  *ngFor="let cat of categories" 
                  [value]="cat.value">
                  {{ cat.label }}
                </ion-select-option>
              </ion-select>
            </ion-item>
    
          </ion-card-content>
        </ion-card>
    
        <!-- ========================================
             ‚úÖ SECTION DATE, HEURE ET DUR√âE
             ======================================== -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="calendar-outline"></ion-icon>
              Date, heure et dur√©e
            </ion-card-title>
          </ion-card-header>
          
          <ion-card-content>
            
            <!-- Bouton pour ouvrir le s√©lecteur de date -->
            <ion-item lines="full" button id="open-datetime-modal">
              <ion-label>Date et heure de d√©but *</ion-label>
              <ion-text slot="end">
                {{ formatSelectedDate(date?.value) }}
              </ion-text>
              <ion-icon name="chevron-forward-outline" slot="end" color="medium"></ion-icon>
            </ion-item>
    
            <!-- Modal avec le datetime picker -->
            <ion-modal trigger="open-datetime-modal" [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime 
                  [value]="date?.value"
                  (ionChange)="onDateChange($event)"
                  presentation="date-time"
                  [min]="minDate"
                  locale="fr-FR"
                  [showDefaultButtons]="true"
                  doneText="Valider"
                  cancelText="Annuler">
                </ion-datetime>
              </ng-template>
            </ion-modal>
    
            <div class="error-message" *ngIf="date?.invalid && date?.touched">
              <ion-text color="danger">
                <small>La date est requise</small>
              </ion-text>
            </div>

            <!-- ‚úÖ NOUVEAU : S√©lecteur de dur√©e -->
            <ion-item lines="full">
              <ion-label position="floating">
                <ion-icon name="time-outline"></ion-icon>
                Dur√©e de l'√©v√©nement *
              </ion-label>
              <ion-select 
                formControlName="duration" 
                interface="action-sheet"
                placeholder="S√©lectionner">
                <ion-select-option 
                  *ngFor="let dur of durations" 
                  [value]="dur.value">
                  {{ dur.label }}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <!-- ‚úÖ NOUVEAU : Affichage de l'heure de fin calcul√©e -->
            <div class="end-time-display" *ngIf="calculatedEndTime">
              <ion-text color="medium">
                <p class="hint">
                  <ion-icon name="time-outline"></ion-icon>
                  Heure de fin : <strong>{{ calculatedEndTime }}</strong>
                </p>
              </ion-text>
            </div>
    
          </ion-card-content>
        </ion-card>
    
        <!-- ========================================
             SECTION LIEU - GOOGLE PLACES AUTOCOMPLETE
             ======================================== -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="location-outline"></ion-icon>
              Lieu
            </ion-card-title>
          </ion-card-header>
          
          <ion-card-content>
            
            <!-- Champ d'autocomplete -->
            <ion-item lines="full" class="address-search-item">
              <ion-label position="floating">üîç Rechercher une adresse *</ion-label>
              <ion-input 
                type="text" 
                [(ngModel)]="addressSearchTerm"
                [ngModelOptions]="{standalone: true}"
                (ionInput)="onAddressSearch($event)"
                placeholder="Ex: 10 rue de la Paix, Paris"
                [disabled]="!isGoogleMapsLoaded">
              </ion-input>
              
              <!-- Spinner pendant la recherche -->
              <ion-spinner 
                *ngIf="isSearching" 
                name="dots" 
                slot="end">
              </ion-spinner>
              <ion-icon 
                *ngIf="!isSearching" 
                name="search-outline" 
                slot="end" 
                color="medium">
              </ion-icon>
            </ion-item>
    
            <!-- Loader Google Maps -->
            <div class="loading-maps" *ngIf="!isGoogleMapsLoaded">
              <ion-spinner name="dots" color="primary"></ion-spinner>
              <p class="hint">Chargement de Google Maps...</p>
            </div>
    
            <!-- Liste des suggestions -->
            <div class="predictions-list" *ngIf="addressPredictions.length > 0">
              <ion-list>
                <ion-item 
                  *ngFor="let prediction of addressPredictions"
                  button
                  (click)="selectAddress(prediction)"
                  class="prediction-item">
                  <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
                  <ion-label>
                    <h3>{{ prediction.mainText }}</h3>
                    <p>{{ prediction.secondaryText }}</p>
                  </ion-label>
                </ion-item>
              </ion-list>
            </div>
    
            <!-- Aucun r√©sultat -->
            <div class="no-results" *ngIf="addressSearchTerm && addressSearchTerm.length >= 3 && addressPredictions.length === 0 && !isSearching">
              <ion-text color="medium">
                <p class="hint">
                  <ion-icon name="search-outline"></ion-icon>
                  Aucune adresse trouv√©e
                </p>
              </ion-text>
            </div>
    
            <!-- ‚úÖ Adresse s√©lectionn√©e -->
            <div class="selected-address" *ngIf="selectedPlaceDetails">
              <ion-card class="address-card">
                <ion-card-content>
                  <div class="address-details">
                    <ion-icon name="checkmark-circle" color="success" class="check-icon"></ion-icon>
                    <div class="address-text">
                      <h3>{{ selectedPlaceDetails.address }}</h3>
                      <p>{{ selectedPlaceDetails.zipCode }} {{ selectedPlaceDetails.city }}</p>
                      <p class="coordinates">
                        üìç {{ selectedPlaceDetails.latitude.toFixed(6) }}, {{ selectedPlaceDetails.longitude.toFixed(6) }}
                      </p>
                    </div>
                    <ion-button 
                      fill="clear" 
                      size="small" 
                      color="danger"
                      (click)="clearAddress()">
                      <ion-icon name="close-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                </ion-card-content>
              </ion-card>
            </div>
    
            <!-- Message d'erreur -->
            <div class="error-message" *ngIf="!selectedPlaceDetails && (eventForm.touched || submitted)">
              <ion-text color="danger">
                <small>Veuillez s√©lectionner une adresse dans la liste</small>
              </ion-text>
            </div>
    
          </ion-card-content>
        </ion-card>
    
        <!-- ========================================
             SECTION PARTICIPANTS
             ======================================== -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="people-outline"></ion-icon>
              Participants
            </ion-card-title>
          </ion-card-header>
          
          <ion-card-content>
            
            <!-- Nombre max de participants -->
            <ion-item lines="full">
              <ion-label position="floating">Nombre maximum de participants *</ion-label>
              <ion-input 
                type="number" 
                formControlName="maxParticipants"
                min="2"
                max="1000"
                placeholder="10">
              </ion-input>
            </ion-item>
            <div class="error-message" *ngIf="maxParticipants?.invalid && maxParticipants?.touched">
              <ion-text color="danger" *ngIf="maxParticipants?.errors?.['min']">
                <small>Minimum 2 participants</small>
              </ion-text>
              <ion-text color="danger" *ngIf="maxParticipants?.errors?.['max']">
                <small>Maximum 1000 participants</small>
              </ion-text>
            </div>
    
          </ion-card-content>
        </ion-card>


        <!-- ========================================
     ‚úÖ SECTION TYPE D'ACC√àS (EventAccessType)
     ======================================== -->
    <ion-card class="event-type-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="shield-checkmark-outline"></ion-icon>
          Type d'acc√®s
        </ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <div class="event-types-container">
          
          <!-- ‚úÖ PRIVATE (Sur invitation - RECOMMAND√â) -->
          <div 
            class="event-type-option"
            [class.selected]="accessType === accessTypeEnum.PRIVATE"
            (click)="selectAccessType(accessTypeEnum.PRIVATE)">
            <div class="type-header">
              <ion-icon name="shield-checkmark-outline" class="type-icon"></ion-icon>
              <span class="recommended-badge">‚≠ê Recommand√©</span>
            </div>
            <h3 class="type-title">üîê Priv√©</h3>
            <p class="type-description">
              Visible par tes amis et leurs amis. Tu valides chaque demande de participation.
            </p>
          </div>

          <!-- ‚úÖ PUBLIC -->
          <div 
            class="event-type-option"
            [class.selected]="accessType === accessTypeEnum.PUBLIC"
            (click)="selectAccessType(accessTypeEnum.PUBLIC)">
            <div class="type-header">
              <ion-icon name="globe-outline" class="type-icon"></ion-icon>
            </div>
            <h3 class="type-title">üåç Public</h3>
            <p class="type-description">
              Visible par tous. N'importe qui peut demander √† participer.
            </p>
          </div>

          <!-- ‚úÖ INVITE_ONLY -->
          <div 
            class="event-type-option"
            [class.selected]="accessType === accessTypeEnum.INVITE_ONLY"
            (click)="selectAccessType(accessTypeEnum.INVITE_ONLY)">
            <div class="type-header">
              <ion-icon name="mail-outline" class="type-icon"></ion-icon>
            </div>
            <h3 class="type-title">‚úâÔ∏è Sur invitation uniquement</h3>
            <p class="type-description">
              Invisible dans la recherche. Seuls les amis invit√©s peuvent voir et rejoindre.
            </p>
          </div>

        </div>

        <!-- ‚ö†Ô∏è Warning pour PUBLIC -->
        <ion-card class="warning-card" *ngIf="accessType === accessTypeEnum.PUBLIC">
          <ion-card-content>
            <div class="warning-content">
              <ion-icon name="alert-circle-outline" color="warning"></ion-icon>
              <div class="warning-text">
                <strong>Attention :</strong> Les √©v√©nements publics peuvent attirer des participants non d√©sir√©s.
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- ‚úÖ NOUVEAU : Section invitations pour INVITE_ONLY -->
        <div class="invitations-section">
          
          <ion-item lines="none" class="invite-header">
            <ion-label>
              <h3>Inviter des amis <span *ngIf="accessType === accessTypeEnum.INVITE_ONLY" class="required">(obligatoire)</span></h3>
              <div class="error-message" *ngIf="accessType === accessTypeEnum.INVITE_ONLY && invitedFriendsCount === 0 && submitted">
                ‚ö†Ô∏è Vous devez inviter au moins 1 ami pour un √©v√©nement sur invitation uniquement
              </div>
            </ion-label>
            <ion-badge slot="end" color="primary">{{ invitedFriendsCount }}</ion-badge>
          </ion-item>

          <!-- Bouton inviter des amis -->
          <ion-button 
            expand="block" 
            fill="outline"
            (click)="openInviteFriendsModal()">
            <ion-icon name="person-add-outline" slot="start"></ion-icon>
            {{ invitedFriendsCount > 0 ? 'Modifier les invit√©s' : 'S√©lectionner des amis' }}
          </ion-button>

          <!-- Liste des amis s√©lectionn√©s -->
          <div class="selected-friends-list" *ngIf="selectedFriends.length > 0">
            <ion-chip 
              *ngFor="let friend of selectedFriends"
              (click)="removeFriend(friend.userId)">
              <ion-avatar>
                <img [src]="friend.photoURL || 'assets/default-avatar.png'" [alt]="friend.displayName" />
              </ion-avatar>
              <ion-label>{{ friend.displayName }}</ion-label>
              <ion-icon name="close-circle" color="danger"></ion-icon>
            </ion-chip>
          </div>

          <!-- Message d'erreur si aucun invit√© -->
          <div class="error-message" *ngIf="accessType === accessTypeEnum.INVITE_ONLY && invitedFriendsCount === 0 && submitted">
            <ion-text color="danger">
              <small>
                <ion-icon name="alert-circle-outline"></ion-icon>
                Vous devez inviter au moins 1 ami
              </small>
            </ion-text>
          </div>

        </div>

      </ion-card-content>
    </ion-card>
    
        <!-- ========================================
             BOUTON CR√âER
             ======================================== -->
        <ion-button 
          expand="block" 
          type="submit" 
          size="large"
          class="create-btn"
          [disabled]="!isFormValid">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Cr√©er l'√©v√©nement
        </ion-button>
    
      </form>
    
    </ion-content>