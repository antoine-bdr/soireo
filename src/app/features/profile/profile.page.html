<!-- ========================================
     üë§ PROFILE PAGE - DARK PREMIUM GLASSMORPHISM
     Design coh√©rent avec event-list et my-events
     ======================================== -->

<!-- ========================================
     HEADER
     ======================================== -->
     <ion-header [translucent]="true">
      <ion-toolbar>
        <ion-title>Mon Profil</ion-title>
        <ion-buttons slot="end" *ngIf="!isEditing">
          <ion-button (click)="enableEditing()">
            <ion-icon name="create-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <!-- ========================================
         CONTENT
         ======================================== -->
    <ion-content [fullscreen]="true">
      
      <!-- Pull-to-refresh -->
      <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
        <ion-refresher-content></ion-refresher-content>
      </ion-refresher>
    
      <!-- ========================================
           LOADING STATE
           ======================================== -->
      <div class="loading-container" *ngIf="isLoading">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <p>Chargement du profil...</p>
      </div>
    
      <!-- ========================================
           PROFIL CHARG√â
           ======================================== -->
      <div class="profile-container" *ngIf="!isLoading && user">
    
        <!-- ========================================
             HEADER AVEC PHOTO
             ======================================== -->
        <div class="profile-header-card glassmorphism">
          <div class="profile-avatar-wrapper">
            <ion-avatar class="profile-avatar">
              <img 
                *ngIf="previewUrl || user.photoURL"
                [src]="previewUrl || user.photoURL" 
                [alt]="user.displayName" />
              <div class="default-avatar" *ngIf="!previewUrl && !user.photoURL">
                <ion-icon name="person-outline"></ion-icon>
              </div>
            </ion-avatar>
    
            <!-- Bouton changement photo (mode √©dition) -->
            <ion-button 
              *ngIf="isEditing"
              class="change-photo-btn" 
              fill="solid" 
              shape="round"
              (click)="triggerFileInput()">
              <ion-icon name="camera-outline" slot="icon-only"></ion-icon>
            </ion-button>
    
            <input 
              type="file" 
              id="fileInput" 
              accept="image/*" 
              (change)="onFileSelected($event)"
              style="display: none;">
          </div>
    
          <h2 class="profile-name">{{ user.displayName }}</h2>
          <p class="profile-email">{{ user.email }}</p>
        </div>
    
        <!-- ========================================
             STATISTIQUES
             ======================================== -->
        <div class="stats-grid">
          <div class="stat-card glassmorphism">
            <div class="stat-number">{{ user.eventsCreatedCount }}</div>
            <div class="stat-label">Cr√©√©s</div>
          </div>
    
          <div class="stat-card glassmorphism">
            <div class="stat-number">{{ user.eventsJoinedCount }}</div>
            <div class="stat-label">Participations</div>
          </div>
    
          <div class="stat-card glassmorphism">
            <div class="stat-number">{{ getMemberSince() }}</div>
            <div class="stat-label">Membre</div>
          </div>
        </div>
    
        <!-- ========================================
             MODE LECTURE
             ======================================== -->
        <div class="info-section" *ngIf="!isEditing">
          
          <!-- Card informations -->
          <div class="info-card glassmorphism">
            <h3 class="section-title">
              <ion-icon name="person-outline"></ion-icon>
              Informations
            </h3>
    
            <div class="info-list">
              <!-- Nom complet -->
              <div class="info-item">
                <ion-icon name="person-outline"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Nom complet</span>
                  <span class="info-value">{{ user.firstName }} {{ user.lastName }}</span>
                </div>
              </div>
    
              <!-- Bio -->
              <div class="info-item" *ngIf="user.bio">
                <ion-icon name="create-outline"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Biographie</span>
                  <span class="info-value bio-text">{{ user.bio }}</span>
                </div>
              </div>
    
              <!-- T√©l√©phone -->
              <div class="info-item" *ngIf="user.phoneNumber">
                <ion-icon name="call-outline"></ion-icon>
                <div class="info-content">
                  <span class="info-label">T√©l√©phone</span>
                  <span class="info-value">{{ user.phoneNumber }}</span>
                </div>
              </div>
    
              <!-- Localisation -->
              <div class="info-item" *ngIf="user.city || user.country">
                <ion-icon name="location-outline"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Localisation</span>
                  <span class="info-value">{{ user.city }}{{ user.city && user.country ? ', ' : '' }}{{ user.country }}</span>
                </div>
              </div>
    
              <!-- Membre depuis -->
              <div class="info-item">
                <ion-icon name="calendar-outline"></ion-icon>
                <div class="info-content">
                  <span class="info-label">Membre depuis</span>
                  <span class="info-value">{{ user.createdAt.toDate() | date: 'dd MMMM yyyy' }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="profile-section">
              <h3 class="section-title">
                <ion-icon name="shield-checkmark-outline"></ion-icon>
                S√©curit√© du compte
              </h3>
            
              <!-- Card Email Verification -->
              <ion-card class="verification-card glassmorphism">
                <ion-card-content>
                  <!-- Email v√©rifi√© ‚úÖ -->
                  <div class="verification-status" *ngIf="isEmailVerified">
                    <div class="status-icon verified">
                      <ion-icon name="checkmark-circle"></ion-icon>
                    </div>
                    <div class="status-content">
                      <p class="status-title">Email v√©rifi√©</p>
                      <p class="status-description">
                        Votre adresse email <strong>{{ userEmail }}</strong> a √©t√© v√©rifi√©e.
                      </p>
                    </div>
                  </div>
            
                  <!-- Email non v√©rifi√© ‚ö†Ô∏è -->
                  <div class="verification-status" *ngIf="!isEmailVerified">
                    <div class="status-icon unverified">
                      <ion-icon name="alert-circle"></ion-icon>
                    </div>
                    <div class="status-content">
                      <p class="status-title">Email non v√©rifi√©</p>
                      <p class="status-description">
                        V√©rifiez votre email <strong>{{ userEmail }}</strong> pour s√©curiser votre compte.
                      </p>
                      
                      <!-- Boutons d'action -->
                      <div class="verification-actions">
                        <ion-button 
                          expand="block" 
                          (click)="sendVerificationEmail()"
                          [disabled]="isLoadingVerification">
                          <ion-icon slot="start" name="mail-outline"></ion-icon>
                          {{ isLoadingVerification ? 'Envoi...' : 'Envoyer l\'email de v√©rification' }}
                        </ion-button>
            
                        <ion-button 
                          expand="block" 
                          fill="outline"
                          (click)="refreshEmailStatus()"
                          [disabled]="isLoadingVerification">
                          <ion-icon slot="start" name="refresh-outline"></ion-icon>
                          J'ai v√©rifi√© mon email
                        </ion-button>
                      </div>
                    </div>
                  </div>
                </ion-card-content>
              </ion-card>
            </div>
    
          <!-- Bouton d√©connexion -->
          <ion-button 
            expand="block"
            class="logout-button"
            color="danger"
            (click)="logout()">
            <ion-icon name="log-out-outline" slot="start"></ion-icon>
            Se d√©connecter
          </ion-button>
        </div>
    
        <!-- ========================================
             MODE √âDITION
             ======================================== -->
        <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" *ngIf="isEditing">
          
          <div class="edit-card glassmorphism">
            <h3 class="section-title">
              <ion-icon name="create-outline"></ion-icon>
              Modifier le profil
            </h3>
    
            <div class="form-fields">
              <!-- Nom complet -->
              <ion-item class="custom-item" lines="none">
                <ion-input
                  label="Nom complet"
                  labelPlacement="stacked"
                  formControlName="displayName"
                  placeholder="Jean Dupont"
                  [counter]="true"
                  maxlength="50">
                </ion-input>
              </ion-item>
    
              <!-- Pr√©nom -->
              <ion-item class="custom-item" lines="none">
                <ion-input
                  label="Pr√©nom"
                  labelPlacement="stacked"
                  formControlName="firstName"
                  placeholder="Jean">
                </ion-input>
              </ion-item>
    
              <!-- Nom -->
              <ion-item class="custom-item" lines="none">
                <ion-input
                  label="Nom"
                  labelPlacement="stacked"
                  formControlName="lastName"
                  placeholder="Dupont">
                </ion-input>
              </ion-item>
    
              <!-- Bio -->
              <ion-item class="custom-item" lines="none">
                <ion-textarea
                  label="Biographie"
                  labelPlacement="stacked"
                  formControlName="bio"
                  placeholder="Parlez-nous de vous..."
                  [counter]="true"
                  maxlength="500"
                  rows="4">
                </ion-textarea>
              </ion-item>
    
              <!-- T√©l√©phone -->
              <ion-item class="custom-item" lines="none">
                <ion-input
                  label="T√©l√©phone"
                  labelPlacement="stacked"
                  formControlName="phoneNumber"
                  type="tel"
                  placeholder="+33 6 12 34 56 78">
                </ion-input>
              </ion-item>
    
              <!-- Ville -->
              <ion-item class="custom-item" lines="none">
                <ion-input
                  label="Ville"
                  labelPlacement="stacked"
                  formControlName="city"
                  placeholder="Paris">
                </ion-input>
              </ion-item>
    
              <!-- Pays -->
              <ion-item class="custom-item" lines="none">
                <ion-input
                  label="Pays"
                  labelPlacement="stacked"
                  formControlName="country"
                  placeholder="France">
                </ion-input>
              </ion-item>
            </div>
          </div>
    
          <!-- Boutons d'action -->
          <div class="action-buttons">
            <ion-button 
              expand="block" 
              class="cancel-button"
              fill="outline"
              (click)="cancelEditing()"
              [disabled]="isSaving">
              Annuler
            </ion-button>
            
            <ion-button 
              expand="block" 
              class="save-button"
              type="submit"
              [disabled]="profileForm.invalid || isSaving">
              <ion-spinner name="crescent" slot="start" *ngIf="isSaving"></ion-spinner>
              <ion-icon name="save-outline" slot="start" *ngIf="!isSaving"></ion-icon>
              Enregistrer
            </ion-button>
          </div>
        </form>
    
      </div>
    
      <!-- ========================================
           √âTAT VIDE
           ======================================== -->
      <div class="empty-state" *ngIf="!isLoading && !user">
        <div class="empty-icon">üë§</div>
        <h3>Profil introuvable</h3>
        <p>Impossible de charger votre profil</p>
        <ion-button class="cta-button" routerLink="/tabs/events">
          Retour √† l'accueil
        </ion-button>
      </div>
    
    </ion-content>